#
# Generated by ansible
#
# Pm2 Ecosystem file
# https://pm2.keymetrics.io/docs/usage/application-declaration/

apps:
{% for app in deploy.apps %}
  - name: "{{ application.fullname }}-{{ app.name }}"
    # https://futurestud.io/tutorials/pm2-use-npm-to-start-your-app
  {% if app.settings.script is not defined %}

    script: npm
    args: start
  {% endif %}

    cwd: "{{ deploy_facts[app.repo | mandatory].source }}/{{ app.path_in_repo | d('') }}"
    pid_file: "{{ application.path }}/pm2/{{ application.fullname }}-{{ app.name }}.pid"
    # instances: 0
    #exec_mode: cluster
    # Logs:
    error_file: "{{ application.path }}/log/pm2/{{ app.name }}-err.log"
    out_file: "{{ application.path }}/log/pm2/{{ app.name }}-out.log"
    time: true
  {% for key, value in app.settings.items() %}

    {{ key | quote }}: {{ value | quote }}
  {% endfor %}
  {% if applications_devmode and app.settings.node_args is not defined%}

    # Lyssna efter debugger som kan ansluta till denna port:
    node_args:
      - "--inspect={{ inventory_hostname }}:{{ 9229 + loop.index0 }}"
  {% endif %}

  {% if app.include_env | d(false) %}

    env: {{ pm2_include_env.results[loop.index0].content | b64decode }}
  {% else %}
    env:
      NODE_ENV: "{{ application.environment }}"
    {% for key, value in app.env.items() %}
         {{ key | quote }}: {{ value | quote }}
    {% endfor %}
  {% endif %}
# Istället för denna används webpack.HotModuleReplacementPlugin vid dev
#  {% if applications_devmode %}
#    watch: true
#    # - dist
#    watch_options:
#     # First: default from pm2 (https://pm2.keymetrics.io/docs/usage/watch-and-restart/)
#      persistent: true
#      ignoreInitial: true
#      # Use polling:
#      usePolling: true
#      interval: 500
#  {% endif %}
{% endfor %}
